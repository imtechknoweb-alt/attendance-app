<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0,
        maximum-scale=1.0, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <title>Attendance System</title>

  <!-- html5-qrcode â€” QR camera scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- CryptoJS â€” AES-256 decryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<style>
/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;
  -webkit-tap-highlight-color:transparent}
:root{
  --blue:   #1a73e8;
  --bludk:  #1557b0;
  --green:  #34a853;
  --orange: #fb8c00;
  --yellow: #f9ab00;
  --red:    #ea4335;
  --bg:     #f0f4f8;
  --card:   #ffffff;
  --txt:    #202124;
  --muted:  #5f6368;
  --border: #dadce0;
  --rad:    14px;
  --shad:   0 2px 16px rgba(0,0,0,0.13);
  --font:   -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif
}
html,body{height:100%;font-family:var(--font);background:var(--bg);
  color:var(--txt);font-size:16px;line-height:1.5;overflow-x:hidden}

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen{display:none;min-height:100vh;flex-direction:column}
.screen.active{display:flex;animation:fadeIn .22s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hdr{background:var(--blue);color:#fff;padding:13px 16px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.22)}
.hdr-title{font-size:17px;font-weight:700;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:58%}
.hdr-right{font-size:13px;font-weight:500;opacity:.92;white-space:nowrap}
.hdr-sub{background:var(--bludk);color:rgba(255,255,255,.88);
  padding:6px 16px;font-size:13px;flex-shrink:0}

/* â”€â”€ LOADING OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.48);
  z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:14px}
#overlay.on{display:flex}
.spin{width:46px;height:46px;border:4px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;animation:spin .75s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-txt{color:#fff;font-size:15px}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:flex;align-items:center;justify-content:center;gap:7px;
  width:100%;height:52px;border:none;border-radius:10px;font-size:16px;
  font-weight:600;font-family:var(--font);cursor:pointer;
  transition:all .16s;text-decoration:none;-webkit-appearance:none}
.btn:active{transform:scale(.97)}
.btn-blue{background:var(--blue);color:#fff;
  box-shadow:0 2px 10px rgba(26,115,232,.38)}
.btn-blue:active{background:var(--bludk)}
.btn-ghost{background:transparent;color:var(--blue);
  border:1.5px solid var(--blue)}
.btn-ghost:active{background:rgba(26,115,232,.08)}
.btn-red{background:var(--red);color:#fff}
.btn-sm{height:40px;font-size:14px;padding:0 16px;
  width:auto;border-radius:8px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 1 â€” LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-login{align-items:center;justify-content:center;
  padding:28px 18px;background:var(--bg)}
.login-card{background:var(--card);border-radius:var(--rad);
  box-shadow:var(--shad);padding:32px 24px;width:100%;max-width:390px}
.avatar{width:74px;height:74px;border-radius:50%;background:var(--blue);
  color:#fff;font-size:30px;font-weight:700;display:flex;
  align-items:center;justify-content:center;margin:0 auto 14px;
  box-shadow:0 4px 14px rgba(26,115,232,.38)}
.school-nm{text-align:center;font-size:19px;font-weight:700;margin-bottom:3px}
.school-sub{text-align:center;font-size:13px;color:var(--muted);margin-bottom:26px}
.lbl{display:block;font-size:12px;font-weight:700;color:var(--muted);
  margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.inp,.sel{width:100%;height:50px;padding:0 14px;border:1.5px solid var(--border);
  border-radius:9px;font-size:16px;font-family:var(--font);color:var(--txt);
  background:#fff;outline:none;transition:border-color .18s;
  appearance:none;-webkit-appearance:none}
.inp:focus,.sel:focus{border-color:var(--blue);
  box-shadow:0 0 0 3px rgba(26,115,232,.13)}
.sel-wrap{position:relative}
.sel-wrap::after{content:"â–¾";position:absolute;right:14px;top:50%;
  transform:translateY(-50%);color:var(--muted);pointer-events:none}
.fg{margin-bottom:20px}
.err-msg{color:var(--red);font-size:13px;margin-top:5px;display:none}
.err-msg.on{display:block}
.test-row{margin-top:11px;text-align:center}
.btn-test{background:transparent;color:var(--muted);
  border:1px solid var(--border);font-size:13px;height:38px;
  border-radius:7px;padding:0 16px;cursor:pointer;font-family:var(--font)}
.conn-status{margin-top:10px;padding:10px 14px;border-radius:8px;
  font-size:13px;display:none;text-align:center;line-height:1.5}
.conn-status.ok{display:block;background:#e6f4ea;color:#137333;border:1px solid #b7dfbf}
.conn-status.fail{display:block;background:#fce8e6;color:#c62828;border:1px solid #f5c6c4}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 2 â€” SCANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-scanner{background:#111;overflow:hidden}
#s-scanner .hdr{background:rgba(0,0,0,.72);backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px)}
#s-scanner .hdr-sub{background:rgba(0,0,0,.55)}

.scan-body{flex:1;display:flex;flex-direction:column;align-items:center;
  padding:14px 16px 10px;overflow-y:auto;-webkit-overflow-scrolling:touch}

/* QR reader container */
#qr-box{width:100%;max-width:310px;border-radius:14px;overflow:hidden;
  border:3px solid var(--blue);
  box-shadow:0 0 0 5px rgba(26,115,232,.22);
  background:#1a1a1a;min-height:290px;position:relative}

/* Camera blocked / fallback panel */
#cam-fallback{display:none;flex-direction:column;align-items:center;
  justify-content:center;text-align:center;padding:28px 18px;
  color:rgba(255,255,255,.78);font-size:14px;line-height:1.75;
  min-height:260px;width:100%;max-width:310px;
  background:#1c1c1c;border-radius:14px;
  border:2px dashed rgba(255,255,255,.18)}
#cam-fallback.on{display:flex}

/* Suppress html5-qrcode UI clutter */
#qr-box video{border-radius:10px !important;width:100% !important}
#qr-box img[alt="Info icon"]{display:none !important}
#qr-box__header_message,
#qr-box__status_span,
#qr-box__filescan_input,
#qr-box__dashboard_section_swaplink{display:none !important}
#qr-box__dashboard_section_csr button{
  background:var(--blue) !important;color:#fff !important;
  border:none !important;border-radius:8px !important;
  padding:10px 22px !important;font-size:15px !important;
  font-family:var(--font) !important;margin-top:10px !important;
  cursor:pointer !important}

.scan-status{color:rgba(255,255,255,.82);font-size:14px;
  margin-top:11px;text-align:center;min-height:22px}
.scan-count{background:rgba(255,255,255,.1);color:rgba(255,255,255,.78);
  padding:4px 14px;border-radius:20px;font-size:12px;
  text-align:center;margin-top:7px}

/* Result card */
.res-card{width:100%;max-width:360px;border-radius:var(--rad);
  padding:16px 18px;margin-top:13px;display:none;
  animation:slideUp .2s ease;box-shadow:var(--shad)}
.res-card.on{display:block}
@keyframes slideUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.res-card.ok   {background:#e6f4ea;border-left:5px solid var(--green)}
.res-card.late {background:#fff3e0;border-left:5px solid var(--orange)}
.res-card.dup  {background:#fef9e7;border-left:5px solid var(--yellow)}
.res-card.err  {background:#fce8e6;border-left:5px solid var(--red)}
.res-title{font-size:18px;font-weight:700;margin-bottom:10px;
  display:flex;align-items:center;gap:8px}
.res-card.ok   .res-title{color:var(--green)}
.res-card.late .res-title{color:var(--orange)}
.res-card.dup  .res-title{color:#b45309}
.res-card.err  .res-title{color:var(--red)}
.res-row{display:flex;font-size:14px;margin-bottom:5px}
.res-lbl{min-width:58px;font-weight:600;color:var(--muted)}

/* Scanner bottom bar */
.scan-bar{background:rgba(0,0,0,.82);backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  padding:10px 16px;
  padding-bottom:max(10px,env(safe-area-inset-bottom));
  display:flex;gap:12px;flex-shrink:0}
.scan-bar .btn{flex:1;height:50px;font-size:14px}
.btn-log{background:rgba(255,255,255,.12);color:#fff;
  border:1.5px solid rgba(255,255,255,.28);border-radius:9px}
.btn-end{background:rgba(234,67,53,.88);color:#fff;border-radius:9px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 3 â€” LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-log{background:var(--bg)}
.log-toolbar{display:flex;gap:10px;align-items:center;
  padding:11px 16px;background:var(--card);
  border-bottom:1px solid var(--border);flex-shrink:0}
.open-sheet{display:flex;align-items:center;justify-content:center;gap:5px;
  text-decoration:none;background:var(--green);color:#fff;
  border-radius:8px;height:40px;padding:0 14px;
  font-size:14px;font-weight:600;font-family:var(--font)}
.sum-bar{background:var(--blue);color:#fff;padding:10px 16px;
  display:flex;justify-content:space-around;flex-shrink:0}
.sum-item{text-align:center}
.sum-num{font-size:22px;font-weight:700;line-height:1}
.sum-lbl{font-size:11px;opacity:.85;margin-top:2px}
.log-body{flex:1;overflow-y:auto;padding:12px 16px 28px;
  -webkit-overflow-scrolling:touch}
.cls-grp{margin-bottom:22px}
.cls-hdr{font-size:14px;font-weight:700;color:var(--blue);
  margin-bottom:8px;padding-bottom:6px;
  border-bottom:2px solid var(--blue);
  display:flex;align-items:center;justify-content:space-between}
.cls-cnt{background:var(--blue);color:#fff;border-radius:12px;
  padding:2px 10px;font-size:12px}
.stu-row{background:var(--card);border-radius:9px;padding:10px 14px;
  margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 5px rgba(0,0,0,.07);border-left:4px solid var(--border);
  user-select:none;cursor:pointer;transition:transform .1s}
.stu-row:active{transform:scale(.98);background:#f5f5f5}
.stu-row.present{border-left-color:var(--green)}
.stu-row.late   {border-left-color:var(--orange)}
.stu-row.absent {border-left-color:var(--red)}
.stu-nm{font-size:15px;font-weight:600}
.stu-meta{font-size:12px;color:var(--muted);margin-top:2px}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;
  font-weight:600;white-space:nowrap}
.b-present{background:#e6f4ea;color:var(--green)}
.b-late   {background:#fff3e0;color:var(--orange)}
.b-absent {background:#fce8e6;color:var(--red)}
.empty{text-align:center;color:var(--muted);padding:52px 24px;font-size:15px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 4 â€” STUDENT REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-report{background:var(--bg)}
.rpt-body{flex:1;overflow-y:auto;padding:20px 16px 36px;
  -webkit-overflow-scrolling:touch}
.rpt-name{font-size:22px;font-weight:700;margin-bottom:4px}
.rpt-meta{font-size:14px;color:var(--muted);margin-bottom:22px}
.circ-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:22px}
.circ{position:relative;width:134px;height:134px}
.circ svg{transform:rotate(-90deg)}
.circ-bg{fill:none;stroke:var(--border);stroke-width:11}
.circ-fill{fill:none;stroke-width:11;stroke-linecap:round;
  transition:stroke-dashoffset .6s ease}
.circ-txt{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center}
.circ-pct{font-size:26px;font-weight:700;line-height:1}
.circ-lbl{font-size:11px;color:var(--muted);margin-top:3px}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:22px}
.stat-box{background:var(--card);border-radius:11px;padding:12px 6px;
  text-align:center;box-shadow:0 1px 5px rgba(0,0,0,.08)}
.stat-n{font-size:22px;font-weight:700;line-height:1}
.stat-box.p .stat-n{color:var(--green)}
.stat-box.l .stat-n{color:var(--orange)}
.stat-box.a .stat-n{color:var(--red)}
.stat-box.t .stat-n{color:var(--blue)}
.stat-lbl{font-size:11px;color:var(--muted);margin-top:4px}
.dots-ttl{font-size:14px;font-weight:600;margin-bottom:10px}
.dots-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.dot-wrap{display:flex;flex-direction:column;align-items:center;gap:4px}
.dot{width:33px;height:33px;border-radius:50%;display:flex;
  align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:#fff}
.dot.present{background:var(--green)}
.dot.late   {background:var(--orange)}
.dot.absent {background:var(--red)}
.dot.no-data{background:var(--border);color:var(--muted)}
.dot-dt{font-size:10px;color:var(--muted)}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="overlay">
  <div class="spin"></div>
  <div class="spin-txt" id="overlay-txt">Please wait...</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 1: LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-login" class="screen active">
  <div class="login-card">

    <div class="avatar" id="av">S</div>
    <div class="school-nm" id="school-nm">Loading...</div>
    <div class="school-sub">Teacher Attendance Portal</div>

    <div class="fg">
      <label class="lbl" for="inp-teacher">Teacher Name</label>
      <input id="inp-teacher" class="inp" type="text"
             placeholder="Enter your full name"
             autocomplete="off" autocorrect="off"
             spellcheck="false" maxlength="60"/>
      <div class="err-msg" id="name-err">Please enter your name.</div>
    </div>

    <div class="fg">
      <label class="lbl" for="inp-section">Session / Section</label>
      <div class="sel-wrap">
        <select id="inp-section" class="sel"></select>
      </div>
    </div>

    <button class="btn btn-blue" onclick="startSession()">
      ğŸ“· &nbsp;Start Scanning
    </button>

    <div class="test-row">
      <button class="btn-test" id="test-btn" onclick="testConn()">
        ğŸ”Œ Test Server Connection
      </button>
    </div>
    <div class="conn-status" id="conn-status"></div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 2: SCANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-scanner" class="screen">

  <div class="hdr">
    <div class="hdr-title" id="scan-school">School</div>
    <div class="hdr-right" id="live-clock">--:-- --</div>
  </div>
  <div class="hdr-sub" id="scan-sub">Teacher: â€” | Session: â€”</div>

  <div class="scan-body">
    <!-- QR viewfinder -->
    <div id="qr-box"></div>

    <!-- Camera fallback -->
    <div id="cam-fallback">
      ğŸ“·<br><br>
      <span id="cam-err-msg">Initializing camera...</span>
    </div>

    <div class="scan-status" id="scan-status">Initializing...</div>
    <div class="scan-count"  id="scan-count">Session scans: 0</div>

    <!-- Result card -->
    <div class="res-card" id="res-card">
      <div class="res-title" id="res-title">âœ… PRESENT</div>
      <div class="res-row"><span class="res-lbl">Name</span><span id="r-name">â€”</span></div>
      <div class="res-row"><span class="res-lbl">ID</span>  <span id="r-id">â€”</span></div>
      <div class="res-row"><span class="res-lbl">Class</span><span id="r-cls">â€”</span></div>
      <div class="res-row"><span class="res-lbl">Time</span><span id="r-time">â€”</span></div>
    </div>
  </div>

  <div class="scan-bar">
    <button class="btn btn-log" onclick="openLog()">ğŸ“‹ Today's Log</button>
    <button class="btn btn-end" onclick="endSession()">ğŸšª End Session</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 3: LOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-log" class="screen">

  <div class="hdr">
    <div class="hdr-title" id="log-hdr">Today's Attendance</div>
  </div>

  <div class="log-toolbar">
    <button class="btn btn-ghost btn-sm" onclick="goScreen('scanner')">
      ğŸ”™ Scanner
    </button>
    <a class="open-sheet btn-sm" id="sheet-link"
       href="#" target="_blank" rel="noopener noreferrer">
      ğŸ”— Open Sheet
    </a>
    <button class="btn btn-ghost btn-sm" onclick="openLog()" style="margin-left:auto">
      ğŸ”„ Refresh
    </button>
  </div>

  <div class="sum-bar">
    <div class="sum-item"><div class="sum-num" id="log-p">0</div><div class="sum-lbl">âœ… Present</div></div>
    <div class="sum-item"><div class="sum-num" id="log-l">0</div><div class="sum-lbl">â° Late</div></div>
    <div class="sum-item"><div class="sum-num" id="log-a">0</div><div class="sum-lbl">âŒ Absent</div></div>
    <div class="sum-item"><div class="sum-num" id="log-t">0</div><div class="sum-lbl">ğŸ“Š Total</div></div>
  </div>

  <div class="log-body" id="log-body">
    <div class="empty">Loading...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 4: REPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-report" class="screen">

  <div class="hdr">
    <div class="hdr-title">Student Report</div>
    <button onclick="goScreen('log')"
      style="background:rgba(255,255,255,.15);color:#fff;border:none;
             height:34px;padding:0 14px;border-radius:7px;
             font-size:14px;font-weight:600;cursor:pointer;
             font-family:var(--font)">
      âœ• Close
    </button>
  </div>

  <div class="rpt-body" id="rpt-body">
    <div class="empty">Loading report...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
"use strict";

// â”€â”€â”€ CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš ï¸  Replace ALL four values below before using the app.
const CONFIG = {
  API_URL:     "AKfycbwCN5NhraOcBs2CwZdssWmCgRH49KRW6GE0hsjmlOrKqxOLYVzR7IQCtcTE_RkbV7V8",
  SECRET_KEY:  "KKASB1964@Attend#2026!",
  SCHOOL_NAME: "KKASB",
  SHEET_URL:   "https://docs.google.com/spreadsheets/d/1LrMp3UZlExOjgPPNY0mKS1xoZj1UhOGMIIPCZWRqvMw/edit",
  COOLDOWN_MS: 3000,
  SECTIONS:    ["All","A","B","C","D"]
};

// â”€â”€â”€ SESSION STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  teacher:     "",
  section:     "All",
  log:         [],
  cooldown:    false,
  scanner:     null,
  clockTimer:  null,
  lpTimer:     null,
  scanCount:   0
};

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("DOMContentLoaded", function () {
  // Validate CONFIG before anything
  if (CONFIG.API_URL.includes("YOUR_APPS_SCRIPT")) {
    console.warn("âš ï¸ API_URL not configured in CONFIG block.");
  }
  if (CONFIG.SECRET_KEY.includes("YOUR_SECRET_KEY")) {
    console.warn("âš ï¸ SECRET_KEY not configured in CONFIG block.");
  }

  // Populate UI
  document.getElementById("school-nm").textContent  = CONFIG.SCHOOL_NAME;
  document.getElementById("av").textContent          = CONFIG.SCHOOL_NAME.charAt(0).toUpperCase();
  document.getElementById("scan-school").textContent = CONFIG.SCHOOL_NAME;
  document.getElementById("sheet-link").href         = CONFIG.SHEET_URL;

  // Section dropdown
  const sel = document.getElementById("inp-section");
  CONFIG.SECTIONS.forEach(function (sec) {
    const o = document.createElement("option");
    o.value       = sec;
    o.textContent = sec === "All" ? "All Sections" : "Section " + sec;
    sel.appendChild(o);
  });

  // Restore session storage
  const t = sessionStorage.getItem("att_teacher") || "";
  const c = sessionStorage.getItem("att_section") || "All";
  document.getElementById("inp-teacher").value = t;
  sel.value = c;
});

// â”€â”€â”€ SCREEN NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goScreen(name) {
  document.querySelectorAll(".screen").forEach(function (s) {
    s.classList.remove("active");
  });
  document.getElementById("s-" + name).classList.add("active");

  if (name === "scanner") {
    startClock();
  } else {
    stopClock();
    if (name !== "scanner" && S.scanner) {
      // Don't stop scanner when just viewing log/report
      // Camera keeps running in background
    }
  }
}

// â”€â”€â”€ LOADING OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoad(txt) {
  document.getElementById("overlay-txt").textContent = txt || "Please wait...";
  document.getElementById("overlay").classList.add("on");
}
function hideLoad() {
  document.getElementById("overlay").classList.remove("on");
}

// â”€â”€â”€ LIVE CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startClock() {
  if (S.clockTimer) return;
  tickClock();
  S.clockTimer = setInterval(tickClock, 1000);
}
function stopClock() {
  if (S.clockTimer) { clearInterval(S.clockTimer); S.clockTimer = null; }
}
function tickClock() {
  const n    = new Date();
  const h    = n.getHours() % 12 || 12;
  const m    = String(n.getMinutes()).padStart(2,"0");
  const s    = String(n.getSeconds()).padStart(2,"0");
  const ap   = n.getHours() >= 12 ? "PM" : "AM";
  const el   = document.getElementById("live-clock");
  if (el) el.textContent = h + ":" + m + ":" + s + " " + ap;
}

// â”€â”€â”€ DATE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayDMY() {
  const n = new Date();
  return String(n.getDate()).padStart(2,"0") + "/" +
         String(n.getMonth()+1).padStart(2,"0") + "/" +
         n.getFullYear();
}
function niceDate(dmy) {
  if (!dmy) return "";
  const p = dmy.split("/");
  if (p.length !== 3) return dmy;
  const mo = ["Jan","Feb","Mar","Apr","May","Jun",
              "Jul","Aug","Sep","Oct","Nov","Dec"];
  return p[0] + " " + mo[+p[1]-1] + " " + p[2];
}

// â”€â”€â”€ SAFE FETCH with timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function apiFetch(params, timeoutMs) {
  timeoutMs = timeoutMs || 12000;

  // Guard: check API_URL is configured
  if (!CONFIG.API_URL || CONFIG.API_URL.includes("YOUR_APPS_SCRIPT")) {
    return Promise.reject(new Error(
      "API_URL not configured. Open index.html and set CONFIG.API_URL."
    ));
  }

  const url = CONFIG.API_URL + "?" + params;
  const ctrl = new AbortController();
  const tid  = setTimeout(function () { ctrl.abort(); }, timeoutMs);

  return fetch(url, {
    method:  "GET",
    cache:   "no-cache",
    mode:    "cors",
    signal:  ctrl.signal
  })
  .then(function (resp) {
    clearTimeout(tid);
    if (!resp.ok) throw new Error("HTTP " + resp.status + " â€” " + resp.statusText);
    return resp.json();
  })
  .catch(function (err) {
    clearTimeout(tid);
    if (err.name === "AbortError") throw new Error("Request timed out after " + (timeoutMs/1000) + "s");
    throw err;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST CONNECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testConn() {
  const btn = document.getElementById("test-btn");
  const box = document.getElementById("conn-status");
  btn.textContent = "Testing...";
  btn.disabled    = true;
  box.className   = "conn-status";
  box.textContent = "";

  // Quick pre-check
  if (!CONFIG.API_URL || CONFIG.API_URL.includes("YOUR_APPS_SCRIPT")) {
    box.className   = "conn-status fail";
    box.textContent = "âŒ API_URL is not set!\nOpen index.html â†’ find CONFIG.API_URL â†’ paste your Apps Script /exec URL.";
    btn.textContent = "ğŸ”Œ Test Server Connection";
    btn.disabled    = false;
    return;
  }

  apiFetch("action=ping", 10000)
    .then(function (data) {
      btn.textContent = "ğŸ”Œ Test Server Connection";
      btn.disabled    = false;
      if (data.status === "ok") {
        box.className   = "conn-status ok";
        box.textContent = "âœ… Connected!  Server time: " + data.time;
      } else {
        box.className   = "conn-status fail";
        box.textContent = "âš ï¸ Unexpected response: " + JSON.stringify(data);
      }
    })
    .catch(function (err) {
      btn.textContent = "ğŸ”Œ Test Server Connection";
      btn.disabled    = false;
      box.className   = "conn-status fail";
      box.textContent =
        "âŒ Connection failed: " + err.message + "\n\n" +
        "Checklist:\n" +
        "â‘  Apps Script deployed as Web App?\n" +
        "â‘¡ 'Who has access' set to Anyone?\n" +
        "â‘¢ URL ends in /exec (not /dev)?\n" +
        "â‘£ Internet working? Try: " + CONFIG.API_URL + "?action=ping";
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 1 â€” SESSION START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSession() {
  const nameEl  = document.getElementById("inp-teacher");
  const nameErr = document.getElementById("name-err");
  const name    = nameEl.value.trim();

  if (!name) {
    nameErr.classList.add("on");
    nameEl.focus();
    return;
  }
  nameErr.classList.remove("on");

  S.teacher   = name;
  S.section   = document.getElementById("inp-section").value;
  S.log       = [];
  S.scanCount = 0;

  sessionStorage.setItem("att_teacher", name);
  sessionStorage.setItem("att_section", S.section);

  document.getElementById("scan-sub").textContent =
    "Teacher: " + name + "  |  Session: " +
    (S.section === "All" ? "All Sections" : "Section " + S.section);

  document.getElementById("scan-count").textContent = "Session scans: 0";

  goScreen("scanner");
  startClock();
  setTimeout(initCamera, 350);
}

function endSession() {
  const ok = S.scanCount === 0
    ? true
    : window.confirm(
        "End session?\n\n" + S.scanCount + " student(s) marked in this session."
      );
  if (!ok) return;
  stopCamera();
  goScreen("login");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 2 â€” CAMERA / QR SCANNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setScanSt(txt) {
  const el = document.getElementById("scan-status");
  if (el) el.textContent = txt;
}

function showFallback(msg) {
  document.getElementById("qr-box").style.display        = "none";
  document.getElementById("cam-err-msg").innerHTML       = msg;
  document.getElementById("cam-fallback").classList.add("on");
}

function hideFallback() {
  document.getElementById("qr-box").style.display        = "";
  document.getElementById("cam-fallback").classList.remove("on");
}

function initCamera() {
  // Clear old instance
  stopCamera();

  // Reset viewfinder
  const box = document.getElementById("qr-box");
  box.innerHTML = "";
  hideFallback();
  setScanSt("Requesting camera permission...");

  // Check API support
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showFallback(
      "âŒ Camera API not available.<br><br>" +
      "This browser does not support camera access.<br>" +
      "Please use <strong>Chrome on Android</strong> or <strong>Safari on iOS</strong>.<br><br>" +
      "Also ensure the page is served over <strong>HTTPS</strong>."
    );
    setScanSt("Camera not supported.");
    return;
  }

  S.scanner = new Html5Qrcode("qr-box", { verbose: false });

  const qrConfig = {
    fps: 8,
    qrbox: function (w, h) {
      const sz = Math.floor(Math.min(w, h) * 0.72);
      return { width: sz, height: sz };
    },
    aspectRatio:            1.0,
    disableFlip:            false,
    rememberLastUsedCamera: true
  };

  // Try exact rear camera first, fall back gracefully
  S.scanner.start(
    { facingMode: { exact: "environment" } },
    qrConfig,
    onQRDecode,
    function () {}   // suppress per-frame errors
  )
  .then(function () {
    hideFallback();
    setScanSt("ğŸ“· Ready to Scan...");
  })
  .catch(function () {
    // Retry without "exact" â€” works on most desktop + some phones
    S.scanner.start(
      { facingMode: "environment" },
      qrConfig,
      onQRDecode,
      function () {}
    )
    .then(function () {
      hideFallback();
      setScanSt("ğŸ“· Ready to Scan...");
    })
    .catch(function (err2) {
      // Final fallback: let html5-qrcode show its own camera picker
      S.scanner.start(
        { facingMode: "user" },
        qrConfig,
        onQRDecode,
        function () {}
      )
      .then(function () {
        hideFallback();
        setScanSt("ğŸ“· Ready to Scan (front cam)...");
      })
      .catch(function (err3) {
        showFallback(
          "ğŸ“· Camera access denied or unavailable.<br><br>" +
          "<strong>To fix on Chrome Android:</strong><br>" +
          "Tap the ğŸ”’ lock icon in the address bar<br>" +
          "â†’ Site settings â†’ Camera â†’ <strong>Allow</strong><br>" +
          "â†’ Reload the page<br><br>" +
          "<strong>To fix on Safari iOS:</strong><br>" +
          "Settings â†’ Safari â†’ Camera â†’ <strong>Allow</strong><br><br>" +
          "<em>Error: " + (err3 ? err3.toString() : "unknown") + "</em>"
        );
        setScanSt("âš ï¸ Camera unavailable.");
      });
    });
  });
}

function stopCamera() {
  if (S.scanner) {
    try {
      S.scanner.stop().catch(function () {});
    } catch (e) {}
    S.scanner = null;
  }
}

// â”€â”€â”€ QR DECODE CALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onQRDecode(rawData) {
  if (S.cooldown) return;
  S.cooldown = true;
  setScanSt("ğŸ”„ Verifying...");

  // â”€â”€ Step 1: Decrypt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let plainText    = "";
  let decryptedOk  = false;

  try {
    const bytes = CryptoJS.AES.decrypt(rawData, CONFIG.SECRET_KEY);
    const txt   = bytes.toString(CryptoJS.enc.Utf8);
    if (txt && txt.length > 0 && txt.indexOf("|") !== -1) {
      plainText   = txt;
      decryptedOk = true;
    }
  } catch (e) {
    decryptedOk = false;
  }

  // â”€â”€ Step 2: Invalid card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!decryptedOk) {
    showRes("err", "âŒ INVALID CARD", "â€”", "â€”", "â€”", "â€”");
    resetAfterDelay();
    return;
  }

  // â”€â”€ Step 3: Extract StudentID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const parts     = plainText.split("|");
  const studentId = (parts[0] || "").trim();

  if (!studentId) {
    showRes("err", "âŒ INVALID CARD", "â€”", "â€”", "â€”", "â€”");
    resetAfterDelay();
    return;
  }

  // â”€â”€ Step 4: Call API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const params =
    "action=scan" +
    "&id="      + encodeURIComponent(studentId) +
    "&teacher=" + encodeURIComponent(S.teacher);

  apiFetch(params, 12000)
    .then(function (data) { handleScanResp(data, studentId); })
    .catch(function (err) {
      let msg = err.message || "Unknown error";
      showRes("err", "âŒ SERVER ERROR", msg, studentId, "â€”", "â€”");
      resetAfterDelay();
    });
}

function handleScanResp(data, scannedId) {
  if (data.status === "success") {
    const isLate = data.attendanceStatus === "Late";
    const cls    = "Class " + (data.studentClass||"?") +
                   " â€” Section " + (data.studentSection||"?");
    showRes(
      isLate ? "late" : "ok",
      isLate ? "â° LATE" : "âœ… PRESENT",
      data.studentName || "â€”",
      scannedId,
      cls,
      data.time || "â€”"
    );
    if (navigator.vibrate) navigator.vibrate([100,50,100]);
    S.scanCount++;
    document.getElementById("scan-count").textContent = "Session scans: " + S.scanCount;
    S.log.push({
      id: scannedId, name: data.studentName,
      cls: data.studentClass, sec: data.studentSection,
      status: data.attendanceStatus, time: data.time
    });

  } else if (data.status === "duplicate") {
    const cls = "Class " + (data.studentClass||"?") +
                " â€” Section " + (data.studentSection||"?");
    showRes("dup","ğŸ” ALREADY MARKED",data.studentName||"â€”",scannedId,cls,data.time||"â€”");
    if (navigator.vibrate) navigator.vibrate(50);

  } else if (data.status === "not_found") {
    showRes("err","âŒ NOT FOUND","Student not in system",scannedId,"â€”","â€”");
    if (navigator.vibrate) navigator.vibrate([200,100,200]);

  } else {
    showRes("err","âŒ ERROR",data.message||"Unknown error",scannedId,"â€”","â€”");
  }

  resetAfterDelay();
}

function showRes(type, title, name, id, cls, time) {
  const card = document.getElementById("res-card");
  card.className = "res-card " + type + " on";
  document.getElementById("res-title").textContent = title;
  document.getElementById("r-name").textContent    = name;
  document.getElementById("r-id").textContent      = id;
  document.getElementById("r-cls").textContent     = cls;
  document.getElementById("r-time").textContent    = time;
  setScanSt(title);
}

function resetAfterDelay() {
  setTimeout(function () {
    document.getElementById("res-card").classList.remove("on");
    setScanSt("ğŸ“· Ready to Scan...");
    S.cooldown = false;
  }, CONFIG.COOLDOWN_MS);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 3 â€” TODAY'S LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLog() {
  goScreen("log");
  const today = todayDMY();
  document.getElementById("log-hdr").textContent =
    "Today â€” " + niceDate(today);
  fetchLog(today);
}

function fetchLog(date) {
  showLoad("Loading attendance...");
  apiFetch("action=getSummary&date=" + encodeURIComponent(date), 15000)
    .then(function (data) {
      hideLoad();
      renderLog(data);
    })
    .catch(function (err) {
      hideLoad();
      document.getElementById("log-body").innerHTML =
        '<div class="empty">âš ï¸ ' + esc(err.message) + '<br><br>' +
        'Check your internet connection and try refreshing.</div>';
    });
}

function renderLog(data) {
  const body = document.getElementById("log-body");

  if (!data || data.status !== "success" || !data.groups || !data.groups.length) {
    body.innerHTML = '<div class="empty">No attendance records for today yet.</div>';
    ["log-p","log-l","log-a","log-t"].forEach(function (id) {
      document.getElementById(id).textContent = "0";
    });
    return;
  }

  let tp = 0, tl = 0, ta = 0, tt = 0, html = "";

  data.groups.forEach(function (g) {
    tp += g.present; tl += g.late; ta += g.absent; tt += g.total;
    html += '<div class="cls-grp">';
    html += '<div class="cls-hdr">Class ' + esc(g.studentClass) +
            ' â€” Section ' + esc(g.section) +
            '<span class="cls-cnt">' + g.students.length + '</span></div>';

    (g.students || []).forEach(function (st) {
      const sc  = st.status.toLowerCase();
      const bdc = "b-" + sc;
      html +=
        '<div class="stu-row ' + sc + '"' +
        ' data-id="' + escAttr(st.id) + '"' +
        ' onmousedown="lpStart(\'' + escAttr(st.id) + '\')"' +
        ' onmouseup="lpEnd()" ontouchstart="lpStart(\'' + escAttr(st.id) + '\')"' +
        ' ontouchend="lpEnd()" ontouchmove="lpEnd()">' +
        '<div>' +
        '<div class="stu-nm">' + esc(st.name) + '</div>' +
        '<div class="stu-meta">' + esc(st.id) + ' &nbsp;â€¢&nbsp; ' + esc(st.time) + '</div>' +
        '</div>' +
        '<span class="badge ' + bdc + '">' + esc(st.status) + '</span>' +
        '</div>';
    });

    html += '</div>';
  });

  body.innerHTML = html;
  document.getElementById("log-p").textContent = tp;
  document.getElementById("log-l").textContent = tl;
  document.getElementById("log-a").textContent = ta;
  document.getElementById("log-t").textContent = tt;
}

// Long press handlers
function lpStart(id) {
  lpEnd();
  S.lpTimer = setTimeout(function () {
    S.lpTimer = null;
    openReport(id);
  }, 600);
}
function lpEnd() {
  if (S.lpTimer) { clearTimeout(S.lpTimer); S.lpTimer = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 4 â€” STUDENT REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openReport(id) {
  goScreen("report");
  document.getElementById("rpt-body").innerHTML =
    '<div class="empty">Loading...</div>';
  showLoad("Loading report...");

  apiFetch("action=getReport&id=" + encodeURIComponent(id), 12000)
    .then(function (data) {
      hideLoad();
      renderReport(data);
    })
    .catch(function (err) {
      hideLoad();
      document.getElementById("rpt-body").innerHTML =
        '<div class="empty">âš ï¸ ' + esc(err.message) + '</div>';
    });
}

function renderReport(data) {
  const body = document.getElementById("rpt-body");

  if (!data || data.status !== "success") {
    body.innerHTML = '<div class="empty">Report not available.</div>';
    return;
  }

  const st   = data.student || {};
  const sv   = data.stats   || {};
  const pct  = parseFloat(sv.attendancePercent) || 0;
  const R    = 56;
  const CIRC = +(2 * Math.PI * R).toFixed(2);
  const OFF  = +(CIRC - (pct / 100) * CIRC).toFixed(2);
  const SC   = pct >= 85 ? "var(--green)" : pct >= 75 ? "var(--orange)" : "var(--red)";

  let dotsHtml = "";
  (data.last7Days || []).forEach(function (d) {
    const s   = d.status || "No Data";
    const dc  = s === "Present" ? "present"
               : s === "Late"   ? "late"
               : s === "Absent" ? "absent"
               : "no-data";
    const ltr = s === "Present" ? "P"
               : s === "Late"   ? "L"
               : s === "Absent" ? "A"
               : "â€“";
    const dt  = d.date ? d.date.substring(0,5) : "â€”";
    dotsHtml +=
      '<div class="dot-wrap">' +
      '<div class="dot ' + dc + '">' + ltr + '</div>' +
      '<div class="dot-dt">' + esc(dt) + '</div>' +
      '</div>';
  });

  body.innerHTML =
    '<div class="rpt-name">'  + esc(st.name   || "â€”") + '</div>' +
    '<div class="rpt-meta">'  + esc(st.id     || "â€”") + ' &nbsp;|&nbsp; ' +
      'Class ' + esc(st.studentClass || "â€”") +
      ' â€” Section ' + esc(st.section || "â€”") + '</div>' +

    '<div class="circ-wrap">' +
    '<div class="circ">' +
    '<svg viewBox="0 0 130 130" width="130" height="130">' +
    '<circle class="circ-bg"   cx="65" cy="65" r="' + R + '"/>' +
    '<circle class="circ-fill" cx="65" cy="65" r="' + R + '"' +
    ' stroke="' + SC + '"' +
    ' stroke-dasharray="'  + CIRC + '"' +
    ' stroke-dashoffset="' + OFF  + '"/>' +
    '</svg>' +
    '<div class="circ-txt">' +
    '<div class="circ-pct">' + pct.toFixed(1) + '%</div>' +
    '<div class="circ-lbl">Attendance</div>' +
    '</div></div></div>' +

    '<div class="stat-grid">' +
    '<div class="stat-box p"><div class="stat-n">' + (sv.present    || 0) + '</div><div class="stat-lbl">Present</div></div>' +
    '<div class="stat-box l"><div class="stat-n">' + (sv.late       || 0) + '</div><div class="stat-lbl">Late</div></div>'    +
    '<div class="stat-box a"><div class="stat-n">' + (sv.absent     || 0) + '</div><div class="stat-lbl">Absent</div></div>'  +
    '<div class="stat-box t"><div class="stat-n">' + (sv.totalDays  || 0) + '</div><div class="stat-lbl">Total Days</div></div>' +
    '</div>' +

    '<div class="dots-ttl">Last 7 Days</div>' +
    '<div class="dots-row">' +
    (dotsHtml || '<span style="color:var(--muted);font-size:13px">No records yet</span>') +
    '</div>';
}

// â”€â”€â”€ XSS HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function escAttr(s) {
  return String(s||"").replace(/'/g,"\\'").replace(/"/g,"&quot;");
}

// â”€â”€â”€ UNLOAD GUARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("beforeunload", function (e) {
  if (S.scanCount > 0) {
    e.preventDefault();
    e.returnValue = "";
  }
});

// â”€â”€â”€ PREVENT DOUBLE-TAP ZOOM ON BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("touchend", function (e) {
  if (e.target.closest("button")) e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
