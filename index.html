<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Attendance System</title>
  <!-- Only HTML5-QRCode needed. No Crypto library! -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
/* ... (Keep your existing CSS, it is good) ... */
/* Add this specific style for WhatsApp button */
.btn-whatsapp {
  background-color: #25D366;
  color: white;
  margin-top: 10px;
  border: none;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-decoration: none;
}
.btn-whatsapp:hover { background-color: #128C7E; }
/* ... */

/* Use the SAME CSS from the previous working version for layout */
body { font-family: sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
.screen { display: none; height: 100%; flex-direction: column; }
.screen.active { display: flex; }
.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px; text-align: center; }
.btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; margin-top: 10px; }
.btn-primary { background: #1a73e8; color: white; }
input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
#reader { width: 100%; height: 100%; object-fit: cover; background: #000; }
.scan-container { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
.scan-overlay { position: absolute; border: 2px solid rgba(255,255,255,0.5); width: 250px; height: 250px; border-radius: 12px; pointer-events: none; }
.popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; width: 80%; max-width: 300px; text-align: center; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; }
</style>
</head>
<body>

<!-- SCREEN 1: LOGIN -->
<div id="screen-login" class="screen active">
  <div class="card">
    <h2>Teacher Login</h2>
    <input type="text" id="teacher" placeholder="Your Name">
    <select id="section">
      <option value="All">All Sections</option>
      <option value="A">Section A</option>
      <option value="B">Section B</option>
    </select>
    <button class="btn btn-primary" onclick="startSession()">Start Scanning</button>
  </div>
</div>

<!-- SCREEN 2: SCANNER -->
<div id="screen-scanner" class="screen">
  <div class="scan-container">
    <div id="reader"></div>
    <div class="scan-overlay"></div>
    
    <!-- RESULT POPUP -->
    <div id="popup" class="popup">
      <div id="p-icon" style="font-size:40px">âœ…</div>
      <h2 id="p-title" style="margin:10px 0">Present</h2>
      <p id="p-name" style="color:#555; margin-bottom:5px">Student Name</p>
      <p id="p-time" style="font-size:12px; color:#888">10:00 AM</p>
      
      <!-- WhatsApp Button Container -->
      <div id="wa-container"></div>
    </div>
  </div>
  
  <div style="padding:15px; background:white; display:flex; gap:10px;">
    <button class="btn" onclick="location.reload()" style="background:#eee; color:#333; margin:0;">Stop</button>
    <div style="flex:1; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#555;">
      <span id="status">Ready</span>
    </div>
  </div>
</div>

<script>
// âš ï¸ ONLY API URL NEEDED NOW. NO SECRET KEY HERE.
const CONFIG = {
  API_URL: "https://script.google.com/macros/s/AKfycbwCN5NhraOcBs2CwZdssWmCgRH49KRW6GE0hsjmlOrKqxOLYVzR7IQCtcTE_RkbV7V8/exec"
};

let scanner = null;
let teacherName = "";
let isScanning = false;

function startSession() {
  teacherName = document.getElementById("teacher").value.trim();
  if(!teacherName) return alert("Enter Name");
  
  document.getElementById("screen-login").classList.remove("active");
  document.getElementById("screen-scanner").classList.add("active");
  
  startCamera();
}

function startCamera() {
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" }, 
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScan,
    () => {}
  );
  document.getElementById("status").innerText = "Scanning...";
  isScanning = true;
}

function onScan(decodedText) {
  if(!isScanning) return;
  isScanning = false;
  
  document.getElementById("status").innerText = "Verifying...";
  if(navigator.vibrate) navigator.vibrate(50);

  // SEND RAW DATA TO SERVER (Server decrypts it)
  const url = CONFIG.API_URL + "?action=scan" +
              "&data=" + encodeURIComponent(decodedText) +
              "&teacher=" + encodeURIComponent(teacherName);

  fetch(url)
    .then(res => res.json())
    .then(data => {
      showResult(data);
    })
    .catch(err => {
      showResult({ status: "error", message: "Connection Failed" });
    });
}

function showResult(data) {
  const popup = document.getElementById("popup");
  const waDiv = document.getElementById("wa-container");
  waDiv.innerHTML = ""; // Clear old button

  let icon = "âŒ";
  let title = "Error";
  let name = data.message || "Unknown";
  let time = "";

  if (data.status === "success") {
    icon = "âœ…";
    title = data.attendanceStatus; // Present / Late
    name = data.studentName;
    time = data.time;
  } else if (data.status === "duplicate") {
    icon = "ðŸ”";
    title = "Already Marked";
    name = data.studentName;
    time = data.time;
  } else if (data.status === "not_found") {
    title = "Not Found";
    name = "Student not in system";
  }

  // Update Popup UI
  document.getElementById("p-icon").innerText = icon;
  document.getElementById("p-title").innerText = title;
  document.getElementById("p-name").innerText = name;
  document.getElementById("p-time").innerText = time;

  // ðŸ’¬ WHATSAPP BUTTON LOGIC
  // Show button if we have a phone number AND student was scanned successfully (or duplicate)
  if (data.parentPhone && (data.status === "success" || data.status === "duplicate")) {
    const msg = `Hello, this is ${CONFIG.SCHOOL_NAME || "School"}. ` +
                `Marking attendance for *${name}*.\n` +
                `Status: *${title}*\n` +
                `Time: ${time}`;
    
    // Construct WhatsApp Link
    const waLink = document.createElement("a");
    waLink.className = "btn btn-whatsapp";
    waLink.href = `https://wa.me/${data.parentPhone}?text=${encodeURIComponent(msg)}`;
    waLink.target = "_blank";
    waLink.innerHTML = "ðŸ’¬ WhatsApp Parent";
    
    waDiv.appendChild(waLink);
  }

  popup.style.display = "block";

  // Auto-close after 2.5s ONLY if user didn't click WhatsApp
  // (We don't auto-close immediately so teacher has time to click)
  setTimeout(() => {
    // Only resume scanning if they haven't clicked away
    // simple UI: just hide popup
    popup.style.display = "none";
    isScanning = true;
    document.getElementById("status").innerText = "Scanning...";
  }, 3000);
}
</script>
</body>
</html>
