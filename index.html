<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Diagnostic</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #222; color: #fff; padding: 20px; text-align: center; }
    .card { background: #333; padding: 20px; border-radius: 10px; max-width: 400px; margin: 0 auto; }
    input, select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
    button { width: 100%; padding: 15px; background: #1a73e8; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    #reader { width: 100%; background: #000; margin-top: 20px; min-height: 300px; }
    .error { color: #ff4444; background: #330000; padding: 10px; margin: 10px 0; display: none; border: 1px solid red; }
    .success { color: #44ff44; background: #003300; padding: 10px; margin: 10px 0; display: none; border: 1px solid green; }
    #status { margin-top: 10px; color: #aaa; }
  </style>
</head>
<body>

<div class="card" id="login-screen">
  <h2>Attendance System</h2>
  <div id="https-warning" class="error">
    ⚠️ CAMERA ERROR: You are not using HTTPS.<br>
    The camera will NOT work on file:// or http://.<br>
    Please host this on GitHub Pages.
  </div>

  <input type="text" id="teacher" placeholder="Teacher Name">
  <select id="section">
    <option value="All">All Sections</option>
    <option value="A">Section A</option>
    <option value="B">Section B</option>
  </select>
  <button onclick="startSession()">START SCANNING</button>
  <div id="api-error" class="error"></div>
</div>

<div class="card" id="scanner-screen" style="display:none;">
  <h3>Scanning...</h3>
  <div id="reader"></div>
  <div id="status">Waiting for camera...</div>
  <div id="result-msg" class="success"></div>
  <div id="error-msg" class="error"></div>
  <button onclick="location.reload()" style="background:#555; margin-top:20px;">Stop / Back</button>
</div>

<script>
// ⚠️ PASTE YOUR URL HERE BETWEEN THE QUOTES
const API_URL = "https://script.google.com/macros/s/AKfycbwCN5NhraOcBs2CwZdssWmCgRH49KRW6GE0hsjmlOrKqxOLYVzR7IQCtcTE_RkbV7V8/exec"; 
const SECRET_KEY = "KKASB1964@Attend#2026!";

// 1. Immediate HTTPS Check
if (location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
  document.getElementById("https-warning").style.display = "block";
  alert("CRITICAL ERROR:\nYou are opening this file insecurely (file:// or http://).\nThe camera BLOCKS insecure connections.\n\nYou MUST host this on GitHub Pages (https) or similar.");
}

// 2. Start Session & Test API
function startSession() {
  const teacher = document.getElementById("teacher").value.trim();
  if(!teacher) return alert("Enter teacher name");

  // Check API URL format
  if(API_URL.includes("YOUR_APPS_SCRIPT") || !API_URL.includes("/exec")) {
    return alert("SETUP ERROR:\nYou did not paste your Web App URL into the code,\nor you pasted the wrong URL.\n\nIt must end in '/exec'.");
  }

  document.getElementById("api-error").style.display = "none";
  const btn = document.querySelector("button");
  btn.textContent = "Testing Connection...";
  btn.disabled = true;

  // Test Connection
  fetch(API_URL + "?action=ping")
    .then(res => {
      if(res.status === 404) throw new Error("404 Not Found (Wrong Deployment URL)");
      if(!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    })
    .then(data => {
      if(data.status !== "ok") throw new Error("Invalid API Response");
      // API OK - Start Camera
      startCamera();
    })
    .catch(err => {
      btn.textContent = "START SCANNING";
      btn.disabled = false;
      const msg = "CONNECTION FAILED: " + err.message + "\n\n1. Did you deploy as 'Anyone'?\n2. Did you copy the '/exec' URL?";
      document.getElementById("api-error").innerText = msg;
      document.getElementById("api-error").style.display = "block";
      alert(msg);
    });
}

// 3. Start Camera
function startCamera() {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("scanner-screen").style.display = "block";

  const scanner = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: 250 };

  scanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
    .catch(err => {
      alert("CAMERA FAILED TO START:\n" + err + "\n\nEnsure you are using HTTPS and allowed permissions.");
      document.getElementById("status").innerText = "Camera Error: " + err;
    });

  window.currentScanner = scanner;
}

// 4. Handle Scan
let isScanning = true;
function onScanSuccess(decodedText) {
  if(!isScanning) return;
  
  try {
    // Decrypt
    const bytes = CryptoJS.AES.decrypt(decodedText, SECRET_KEY);
    const originalText = bytes.toString(CryptoJS.enc.Utf8);
    
    if(!originalText.includes("|")) throw new Error("Decryption failed");

    const parts = originalText.split("|");
    const id = parts[0];
    const name = parts[1];

    isScanning = false;
    document.getElementById("status").innerText = "Verifying " + name + "...";
    
    // Call API
    const teacher = document.getElementById("teacher").value;
    fetch(API_URL + "?action=scan&id=" + encodeURIComponent(id) + "&teacher=" + encodeURIComponent(teacher))
      .then(res => res.json())
      .then(data => {
        const div = document.getElementById("result-msg");
        div.style.display = "block";
        div.innerText = "✅ " + (data.studentName || name) + ": " + data.attendanceStatus;
        
        // Cooldown
        setTimeout(() => {
          div.style.display = "none";
          document.getElementById("status").innerText = "Ready to scan...";
          isScanning = true;
        }, 3000);
      })
      .catch(err => {
        alert("Network Error: " + err.message);
        isScanning = true;
      });

  } catch(e) {
    console.log("Invalid QR");
  }
}

function onScanError(errorMessage) {
  // Ignore scan errors, they happen every frame no QR is found
}
</script>
</body>
</html>
